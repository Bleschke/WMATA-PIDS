<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WMATA PIDS (Docker Build)</title>
  <style>
    :root {
      --bg: #0d0f11;
      --text: #eaf0f6;
      --muted: #9fb3c8;
      --header-blue: #7bb7ff;
      --banner-blue: #3b82f6;
      --row-alt: #13181e;

      --line-RD:#BF0D3E;
      --line-OR:#DA8707;
      --line-SV:#A0A0A0;
      --line-BL:#0076C0;
      --line-YL:#F3D03E;
      --line-GR:#1DB954;
    }
    * { box-sizing: border-box; }
    body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 18px; }
    .screen { border-radius: 14px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.45); border: 1px solid #1f2937; }
    .topband { background:var(--header-blue); color:#0b2039; font-weight:700; display:grid; grid-template-columns:1.1fr 1.1fr 5fr 1fr; padding:12px 16px; font-size:22px; }
    .rows { font-size:26px; }
    .row { display:grid; grid-template-columns:1.1fr 1.1fr 5fr 1fr; align-items:center; gap:8px; padding:14px 16px; border-top:1px solid #17202a; }
    .row:nth-child(odd){ background: var(--row-alt); }
    .dest { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .badge { display:inline-flex; align-items:center; justify-content:center; width:42px; height:42px; border-radius:50%; font-weight:800; color:#0c1117; border:2px solid #111827; }
    .ln-RD{background:var(--line-RD)} .ln-OR{background:var(--line-OR)} .ln-SV{background:var(--line-SV)} .ln-BL{background:var(--line-BL)} .ln-YL{background:var(--line-YL)} .ln-GR{background:var(--line-GR)}
    .cars{ font-variant-numeric: tabular-nums; } .cars sup{ font-size:.55em; margin-left:4px; } .mins{ font-variant-numeric: tabular-nums; text-align:right; font-weight:700; }
    .banner { background:var(--banner-blue); color:white; padding:10px 16px; font-size:22px; display:flex; justify-content:space-between; gap:12px; }
    .banner span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .toolbar { display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; padding:8px 2px 16px; color:var(--muted); font-size:14px; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill { border:1px solid #334155; border-radius:999px; padding:6px 10px; display:inline-flex; gap:8px; align-items:center; background:#0b1220; }
    .pill input[type=text]{ background:transparent; border:none; color:var(--text); font-weight:700; outline:none; font-size:14px; }
    .pill input.station{ width:9ch; text-transform:uppercase; }
    .pill button{ background:#111827; border:1px solid #334155; color:#cbd5e1; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .pill button:hover{ filter:brightness(1.1); }
    .pill input[type=password]{ background:transparent; border:none; color:var(--text); outline:none; font-size:14px; width:240px; }
    .err { color:#fca5a5; font-size:16px; padding:0 4px 8px; }
    .hidden { display:none !important; }

    .cols { display:grid; grid-template-columns:1fr 1fr; }
    .col { border-left:1px solid #17202a; }
    .col:first-child { border-left:none; }
    .col .rows { min-height:360px; }
    .col-title { background:#0f172a; color:#9fb3c8; padding:8px 12px; font-weight:600; border-top:1px solid #17202a; }

    .overlay {
      position: fixed; right: 14px; bottom: 14px; z-index: 40;
      background: rgba(10,14,20,.9); color: #e5e7eb; border: 1px solid #334155;
      border-radius: 12px; padding: 12px 14px; min-width: 300px; max-width: 420px;
      box-shadow: 0 10px 30px rgba(0,0,0,.5); backdrop-filter: blur(2px);
    }
    .overlay h4 { margin: 0 0 6px 0; font-size: 16px; color: #93c5fd; }
    .overlay table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .overlay th, .overlay td { text-align: left; padding: 4px 6px; border-bottom: 1px solid #1f2937; }
    .overlay th { color: #9fb3c8; font-weight: 600; }
    .overlay .muted { color: #9fb3c8; font-size: 12px; }
    .overlay .rowline{ font-weight:700; }

    .cars .person { display:inline-block; vertical-align: top; margin-left: 6px; width: 16px; height: 16px; }
    .cars .person svg { width: 16px; height: 16px; fill: currentColor; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div>Unofficial WMATA PIDS demo • refreshes every 15s</div>
      <div id="controlsWrap"><div class="controls">
        <button id="fsBtn" class="pill" title="Toggle Full Screen">Full screen</button>
        <label class="pill"><input type="checkbox" id="tvMode" title="Press T to toggle" /> TV mode (hide controls)</label>
        <div class="pill">
          <label>Station:&nbsp;</label>
          <input id="stationInput" class="station" maxlength="4" placeholder="F02" />
          <button id="saveBtn">Set</button>
          <button id="lookupBtn">Search name</button>
        </div>
        <label class="pill"><input type="checkbox" id="twoCols" /> Two columns by platform group</label>
        <label class="pill"><input type="checkbox" id="autoAlerts" /> Auto WMATA alerts</label>
        <div class="pill" style="max-width:420px;">
          <label>Banner:&nbsp;</label>
          <input id="bannerInput" type="text" placeholder="Custom banner message…" style="width:320px;" />
          <button id="bannerSave">Set</button>
        </div>
        <label class="pill"><input type="checkbox" id="analyticsBox" /> Analytics overlay</label>
        <div class="pill" style="max-width:520px;">
          <label>API key:&nbsp;<span id="apiKeyDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:red;margin-left:4px;"></span></label>
          <input id="apiKeyInput" type="password" placeholder="Enter new key" />
          <label style="display:flex; align-items:center; gap:6px; padding-left:6px;">
            <input type="checkbox" id="apiKeyPersist" /> Persist to .env
          </label>
          <button id="apiKeySave">Save</button>
          <button id="apiKeyClear" title="Clear key on server">Clear</button>
        </div>
      </div></div>
    </div>

    <div id="error" class="err" style="display:none;"></div>

    <div id="apiKeyStatus" style="display:none;"></div>
    <div class="screen">
      <div id="singleHeader" class="topband">
        <div>LN</div><div>CAR</div><div>DESTINATION</div><div style="text-align:right;">MIN</div>
      </div>
      <div id="singleRows" class="rows"></div>

      <div id="twoColWrap" style="display:none;">
        <div class="cols">
          <div class="col">
            <div class="topband"><div>LN</div><div>CAR</div><div>DESTINATION</div><div style="text-align:right;">MIN</div></div>
            <div class="col-title">Platform Group 1</div>
            <div id="rowsG1" class="rows"></div>
          </div>
          <div class="col">
            <div class="topband"><div>LN</div><div>CAR</div><div>DESTINATION</div><div style="text-align:right;">MIN</div></div>
            <div class="col-title">Platform Group 2</div>
            <div id="rowsG2" class="rows"></div>
          </div>
        </div>
      </div>

      <div class="banner">
        <span id="bannerText">Subscribe to alerts at wmata.com/alerts</span>
        <span id="bannerMeta"></span>
      </div>
    </div>
  </div>

  <div id="analyticsPanel" class="overlay" style="display:none;"></div>

<script>
const stationInput = document.getElementById('stationInput');
const saveBtn = document.getElementById('saveBtn');
const lookupBtn = document.getElementById('lookupBtn');
const errorEl = document.getElementById('error');
const twoColsEl = document.getElementById('twoCols');
const autoAlertsEl = document.getElementById('autoAlerts');
const bannerInput = document.getElementById('bannerInput');
const bannerSave = document.getElementById('bannerSave');
const analyticsBox = document.getElementById('analyticsBox');
const analyticsPanel = document.getElementById('analyticsPanel');

const singleHeader = document.getElementById('singleHeader');
const singleRows = document.getElementById('singleRows');
const twoColWrap = document.getElementById('twoColWrap');
const rowsG1 = document.getElementById('rowsG1');
const rowsG2 = document.getElementById('rowsG2');
const bannerText = document.getElementById('bannerText');
const bannerMeta = document.getElementById('bannerMeta');

const fsBtn = document.getElementById('fsBtn');
const tvModeEl = document.getElementById('tvMode');
const controlsWrap = document.getElementById('controlsWrap');

const apiKeyInput = document.getElementById('apiKeyInput');
const apiKeySave = document.getElementById('apiKeySave');
const apiKeyClear = document.getElementById('apiKeyClear');
const apiKeyStatus = document.getElementById('apiKeyStatus');
const apiKeyDot = document.getElementById('apiKeyDot');

function getStation() {
  const urlParams = new URLSearchParams(window.location.search);
  const q = (urlParams.get('station') || localStorage.getItem('wmata_station') || '').toUpperCase();
  return q || '';
}
function setStation(code) {
  const c = (code || '').toUpperCase().trim();
  if (c.length) {
    localStorage.setItem('wmata_station', c);
    stationInput.value = c;
    fetchAndRender();
  }
}
function lineBadge(line) {
  const ln = (line || '').toUpperCase();
  const known = ['RD','OR','SV','BL','YL','GR'];
  const klass = known.includes(ln) ? ln : 'SV';
  return `<span class="badge ln-${klass}">${ln||'--'}</span>`;
}
function carCell(car) {
  let c = (car || '').toString();
  if (!c || c === '—') c = '--';
  const personSVG = `<span class="person" aria-label="person" title="person">
      <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
        <circle cx="12" cy="6" r="3"></circle>
        <path d="M9 22v-7H7l2-6a3 3 0 0 1 5.9 0l2 6h-2v7h-2v-5h-2v5H9z"></path>
      </svg>
    </span>`;
  return `<span class="cars">${c}${personSVG}</span>`;
}
function minCell(min) {
  let m = (min || '').toString();
  if (!m || m === '—') m = '--';
  return `<div class="mins">${m}</div>`;
}
function rowHTML(t) {
  const dest = t.DestinationName || t.Destination || '--';
  return `<div class="row">
    <div>${lineBadge(t.Line)}</div>
    <div>${carCell(t.Car)}</div>
    <div class="dest">${dest}</div>
    ${minCell(t.Min)}
  </div>`;
}

async function fetchPredictions() {
  const station = getStation();
  if (!station) throw new Error('Enter a station code (e.g., F02)');
  const resp = await fetch(`/api/predictions?station=${encodeURIComponent(station)}`);
  const data = await resp.json();
  if (!resp.ok) throw new Error((data and data.error) || 'API error');
  return data;
}
function renderSingle(trains) {
  singleHeader.style.display = '';
  singleRows.style.display = '';
  twoColWrap.style.display = 'none';
  const items = trains.slice(0, 10);
  singleRows.innerHTML = items.length ? items.map(rowHTML).join('') :
    `<div class="row"><div></div><div></div><div class="dest">No predictions.</div>${minCell('--')}</div>`;
}
function renderTwoCols(trains) {
  singleHeader.style.display = 'none';
  singleRows.style.display = 'none';
  twoColWrap.style.display = '';
  const g1 = trains.filter(t => (t.Group || '').toString() === '1').slice(0,8);
  const g2 = trains.filter(t => (t.Group || '').toString() === '2').slice(0,8);
  rowsG1.innerHTML = g1.length ? g1.map(rowHTML).join('') :
    `<div class="row"><div></div><div></div><div class="dest">No predictions for Group 1.</div>${minCell('--')}</div>`;
  rowsG2.innerHTML = g2.length ? g2.map(rowHTML).join('') :
    `<div class="row"><div></div><div></div><div class="dest">No predictions for Group 2.</div>${minCell('--')}</div>`;
}
async function fetchAndRender() {
  try {
    errorEl.style.display = 'none';
    const data = await fetchPredictions();
    const trains = (data.trains || []);
    window._lastTrains = trains;
    if (twoColsEl.checked) renderTwoCols(trains);
    else renderSingle(trains);
    renderAnalytics(trains);
  } catch (e) {
    errorEl.style.display = 'block';
    errorEl.textContent = 'Failed to load predictions. Is WMATA_API_KEY set on the server? (' + e.message + ')';
    singleRows.innerHTML = '';
    rowsG1.innerHTML = '';
    rowsG2.innerHTML = '';
  }
}

// Alerts/banner
async function refreshBanner() {
  if (autoAlertsEl && autoAlertsEl.checked) {
    try {
      const r = await fetch('/api/incidents');
      const d = await r.json();
      if (!r.ok) throw new Error(d.error || 'Incidents API error');
      const inc = d.incidents || [];
      if (inc.length === 0) {
        bannerText.textContent = 'No reported rail incidents • wmata.com/alerts';
        bannerMeta.textContent = '';
        return;
      }
      const first = inc.find(i => (i._lines||[]).length) || inc[0];
      const msg = first._description || 'Service update reported.';
      const tag = (first._lines && first._lines.length) ? `(${first._lines.join('/')})` : '';
      bannerText.textContent = `${msg} ${tag}`.trim();
      bannerMeta.textContent = 'Auto alerts';
    } catch (e) {
      bannerText.textContent = 'Alerts unavailable. Check wmata.com/alerts';
      bannerMeta.textContent = '';
    }
  } else {
    const custom = (localStorage.getItem('wmata_banner') || '').trim();
    bannerText.textContent = custom || 'Subscribe to alerts at wmata.com/alerts';
    bannerMeta.textContent = custom ? 'Custom' : '';
  }
}

// Analytics overlay
function summarizeTrains(trains) {
  const perLine = {};
  const byGroup = { '1':0, '2':0 };
  let total = 0;
  for (const t of trains) {
    const ln = (t.Line || '').toUpperCase() || '--';
    const g = (t.Group || '').toString();
    const minStr = (t.Min || '').toString();
    let m = null;
    if (minStr === 'BRD' || minStr === 'ARR') m = 0;
    else {
      const n = parseInt(minStr,10);
      if (!isNaN(n)) m = n;
    }
    if (!perLine[ln]) perLine[ln] = { count: 0, soonestMin: null };
    perLine[ln].count += 1;
    if (m !== null) {
      if (perLine[ln].soonestMin === null || m < perLine[ln].soonestMin) perLine[ln].soonestMin = m;
    }
    if (g === '1' || g === '2') byGroup[g] += 1;
    total += 1;
  }
  return { perLine, byGroup, total };
}
function renderAnalytics(trains) {
  if (!analyticsBox.checked) { analyticsPanel.style.display = 'none'; return; }
  const s = summarizeTrains(trains);
  const lines = Object.keys(s.perLine).sort();
  let rows = '';
  for (const ln of lines) {
    const it = s.perLine[ln];
    const soon = (it.soonestMin === null) ? '—' : it.soonestMin.toString();
    rows += `<tr><td class="rowline">${ln}</td><td>${it.count}</td><td>${soon}</td></tr>`;
  }
  analyticsPanel.innerHTML = `
    <h4>Next trains summary</h4>
    <table>
      <thead><tr><th>Line</th><th>#</th><th>Soonest (min)</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="3">No data</td></tr>'}</tbody>
    </table>
    <div class="muted" style="margin-top:6px;">Total: ${s.total} • Group1: ${s.byGroup['1']} • Group2: ${s.byGroup['2']}</div>
  `;
  analyticsPanel.style.display = '';
}
analyticsBox.addEventListener('change', () => {
  localStorage.setItem('wmata_analytics', analyticsBox.checked ? '1' : '0');
  if (window._lastTrains) renderAnalytics(window._lastTrains);
});

// Fullscreen + TV mode
async function toggleFullscreen() {
  const doc = document;
  const el = document.documentElement;
  if (!doc.fullscreenElement) {
    if (el.requestFullscreen) await el.requestFullscreen();
  } else {
    if (doc.exitFullscreen) await doc.exitFullscreen();
  }
}
fsBtn.addEventListener('click', toggleFullscreen);

function applyTvMode() {
  const on = tvModeEl.checked;
  if (controlsWrap) controlsWrap.classList.toggle('hidden', on);
  localStorage.setItem('wmata_tv', on ? '1' : '0');
}
tvModeEl.addEventListener('change', applyTvMode);

// Keyboard shortcuts: T = TV mode, F = Fullscreen
document.addEventListener('keydown', (e) => {
  const tag = (e.target && e.target.tagName || '').toLowerCase();
  if (tag === 'input' || tag === 'textarea') return;
  if (e.key === 't' || e.key === 'T') {
    tvModeEl.checked = !tvModeEl.checked;
    applyTvMode();
  } else if (e.key === 'f' || e.key === 'F') {
    toggleFullscreen();
  }
});

// API key management
async function refreshApiKeyStatus() {
  try {
    const r = await fetch('/api/config');
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Failed to read config');
    if (apiKeyDot) apiKeyDot.style.background = d.has_key ? 'limegreen' : 'red';
  } catch (e) {
    if (apiKeyDot) apiKeyDot.style.background = 'red';
  }
}
apiKeySave?.addEventListener('click', async () => {
  const value = (apiKeyInput.value || '').trim();
  try {
    const r = await fetch('/api/config', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ api_key: value, persist: !!document.getElementById('apiKeyPersist')?.checked })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Save failed');
    apiKeyInput.value = '';
    await refreshApiKeyStatus();
    fetchAndRender();
    refreshBanner();
    alert('API key saved on server.');
  } catch (e) {
    alert('Failed to save API key: ' + e.message);
  }
});
apiKeyClear?.addEventListener('click', async () => {
  try {
    const r = await fetch('/api/config', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ api_key: '', persist: !!document.getElementById('apiKeyPersist')?.checked })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Clear failed');
    await refreshApiKeyStatus();
    alert('API key cleared on server.');
  } catch (e) {
    alert('Failed to clear API key: ' + e.message);
  }
});

// Station lookup
lookupBtn.addEventListener('click', async () => {
  const name = prompt("Type part of a station name to search (e.g., 'vernon' or 'greenbelt'):");
  if (!name) return;
  try {
    const r = await fetch(`/api/stations?q=${encodeURIComponent(name)}`);
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Search failed');
    if (!d.results || d.results.length === 0) { alert('No stations found.'); return; }
    const opts = d.results.map(s => `${s.name} — ${s.code} — ${ (s.line_codes || []).filter(Boolean).join('/') }`);
    const choice = prompt(`Results:\n\n${opts.map((t,i)=>`${i+1}. ${t}`).join('\n')}\n\nEnter the number to select:`);
    const idx = parseInt(choice,10) - 1;
    if (!isNaN(idx) && d.results[idx]) setStation(d.results[idx].code);
  } catch (e) {
    alert('Lookup error: ' + e.message);
  }
});

// Init
stationInput.value = getStation();
twoColsEl.checked = localStorage.getItem('wmata_two_cols') === '1';
autoAlertsEl.checked = localStorage.getItem('wmata_auto_alerts') === '1';
analyticsBox.checked = localStorage.getItem('wmata_analytics') === '1';
bannerInput.value = localStorage.getItem('wmata_banner') || '';

(function initTvFromUrl(){
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('tv') === '1') tvModeEl.checked = true;
  else tvModeEl.checked = localStorage.getItem('wmata_tv') === '1';
  applyTvMode();
})();

fetchAndRender();
refreshBanner();
setInterval(fetchAndRender, 15000);
setInterval(refreshBanner, 60000);
refreshApiKeyStatus();
</script>
</body>
</html>
